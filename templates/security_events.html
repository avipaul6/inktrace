<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üõ°Ô∏è Security Events - Inktrace</title>
    <link rel="stylesheet" href="/static/css/dashboard.css">
</head>
<body>
    <div class="app-layout">
        <!-- Modern Sidebar (Same as Dashboard) -->
        <div class="sidebar">
            <div class="logo">üêô</div>
            <nav class="nav-items">
                <a href="/" class="nav-item" title="Dashboard">üè†</a>
                <a href="/communications" class="nav-item" title="Communications">üì°</a>
                <a href="/security-events" class="nav-item active" title="Security Events">üõ°Ô∏è</a>
                <a href="/api/agents" target="_blank" class="nav-item" title="API">üîå</a>
            </nav>
            <div class="sidebar-bottom">
                <div class="user-avatar">JD</div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Header -->
            <div class="header">
                <h1 class="greeting">üõ°Ô∏è Security Events Monitor</h1>
                <div class="demo-controls">
                    <button class="demo-btn primary" onclick="refreshEvents()">
                        üîÑ Refresh
                    </button>
                    <button class="demo-btn secondary" onclick="clearAllEvents()">
                        üóëÔ∏è Clear All
                    </button>
                    <button class="demo-btn secondary" onclick="window.location.href='/'">
                        üè† Back to Dashboard
                    </button>
                </div>
            </div>

            <!-- Security Events Content -->
            <div class="dashboard-layout" style="grid-template-columns: 1fr 1fr;">
                <!-- Event Stats -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">
                            <span class="card-icon">üìä</span>
                            Event Statistics
                        </div>
                    </div>
                    <div class="intel-grid">
                        <div class="intel-item">
                            <div class="intel-label">Total Events</div>
                            <div class="intel-value primary" id="total-events">0</div>
                        </div>
                        <div class="intel-item">
                            <div class="intel-label">Critical</div>
                            <div class="intel-value critical" id="critical-events">0</div>
                        </div>
                        <div class="intel-item">
                            <div class="intel-label">High Priority</div>
                            <div class="intel-value warning" id="high-events">0</div>
                        </div>
                        <div class="intel-item">
                            <div class="intel-label">Info</div>
                            <div class="intel-value success" id="info-events">0</div>
                        </div>
                    </div>
                </div>

                <!-- Recent Critical Alerts -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">
                            <span class="card-icon">üö®</span>
                            Critical Alerts
                        </div>
                        <div class="card-badge">Live</div>
                    </div>
                    <div id="critical-alerts-list">
                        <div class="empty-state">
                            <div class="empty-icon">‚úÖ</div>
                            <p>No critical alerts</p>
                            <p style="font-size: 0.8rem; color: #6b7280; margin-top: 0.5rem;">
                                All systems operating normally
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- All Security Events -->
            <div class="dashboard-row-2">
                <div class="card" style="grid-column: 1 / -1;">
                    <div class="card-header">
                        <div class="card-title">
                            <span class="card-icon">üìã</span>
                            All Security Events
                        </div>
                        <div class="card-badge">Last 24 hours</div>
                    </div>
                    <div class="events-timeline" id="all-events-list" style="max-height: 500px;">
                        <div class="loading">Loading security events...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        console.log('üõ°Ô∏è Inktrace Security Events Monitor loaded');

        async function refreshEvents() {
            try {
                const response = await fetch('/api/security-events');
                const data = await response.json();
                updateSecurityEvents(data);
            } catch (error) {
                console.error('Error refreshing security events:', error);
            }
        }

        async function clearAllEvents() {
            if (confirm('Are you sure you want to clear all security events?')) {
                try {
                    await fetch('/api/security-events/clear', { method: 'POST' });
                    refreshEvents();
                } catch (error) {
                    console.error('Error clearing events:', error);
                }
            }
        }

        function updateSecurityEvents(data) {
            const events = data.events || [];
            
            // Update stats
            const totalEvents = events.length;
            const criticalEvents = events.filter(e => e.severity === 'critical').length;
            const highEvents = events.filter(e => e.severity === 'high').length;
            const infoEvents = events.filter(e => e.severity === 'info').length;

            document.getElementById('total-events').textContent = totalEvents;
            document.getElementById('critical-events').textContent = criticalEvents;
            document.getElementById('high-events').textContent = highEvents;
            document.getElementById('info-events').textContent = infoEvents;

            // Update critical alerts
            const criticalAlerts = events.filter(e => e.severity === 'critical');
            const criticalContainer = document.getElementById('critical-alerts-list');
            
            if (criticalAlerts.length === 0) {
                criticalContainer.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">‚úÖ</div>
                        <p>No critical alerts</p>
                        <p style="font-size: 0.8rem; color: #6b7280; margin-top: 0.5rem;">
                            All systems operating normally
                        </p>
                    </div>
                `;
            } else {
                const alertsHtml = criticalAlerts.slice(0, 3).map(event => {
                    const threatScore = event.threat_score || 0;
                    const agentName = event.agent_name || event.source || 'Unknown';
                    
                    return `
                        <div class="agent-item critical">
                            <div class="agent-info">
                                <div class="agent-name">üö® ${event.type || 'Critical Alert'}</div>
                                <div class="agent-details">
                                    <span>‚è∞ ${new Date(event.timestamp).toLocaleTimeString()}</span>
                                    <span>üìç Agent: ${agentName}</span>
                                    ${threatScore > 0 ? `<span>‚ö†Ô∏è Threat: ${threatScore}/100</span>` : ''}
                                </div>
                            </div>
                            <div class="agent-metric critical">Critical</div>
                        </div>
                    `;
                }).join('');
                criticalContainer.innerHTML = alertsHtml;
            }

            // Update all events list
            const allEventsContainer = document.getElementById('all-events-list');
            
            if (events.length === 0) {
                allEventsContainer.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">üìä</div>
                        <p>No security events recorded</p>
                        <p style="font-size: 0.8rem; color: #6b7280; margin-top: 0.5rem;">
                            Events will appear here as they occur
                        </p>
                    </div>
                `;
            } else {
                // Sort events by timestamp (newest first)
                const sortedEvents = [...events].sort((a, b) => {
                    const timeA = new Date(a.timestamp || 0);
                    const timeB = new Date(b.timestamp || 0);
                    return timeB - timeA;
                });

                const eventsHtml = sortedEvents.map(event => {
                    const indicatorClass = event.severity === 'critical' ? 'critical' : 
                                          event.severity === 'high' ? 'info' : 'success';
                    const icon = event.severity === 'critical' ? 'üö®' : 
                                event.severity === 'high' ? '‚ö†Ô∏è' : '‚úì';

                    // Enhanced event details for threats
                    const threatScore = event.threat_score || 0;
                    const agentName = event.agent_name || event.source || 'System';
                    const securityAlerts = event.security_alerts || [];
                    
                    let threatDetails = '';
                    if (event.severity === 'critical' && threatScore > 0) {
                        threatDetails = `
                            <div style="margin-top: 0.5rem; padding: 0.5rem; background: rgba(239, 68, 68, 0.1); border-radius: 6px; border-left: 3px solid #ef4444;">
                                <div style="font-weight: 600; color: #ef4444; font-size: 0.8rem; margin-bottom: 0.25rem;">
                                    üö® THREAT DETAILS:
                                </div>
                                <div style="font-size: 0.75rem; color: #7f1d1d;">
                                    <div>‚Ä¢ Agent: ${agentName}</div>
                                    <div>‚Ä¢ Threat Score: ${threatScore}/100</div>
                                    <div>‚Ä¢ Port: ${event.port || 'Unknown'}</div>
                                    ${securityAlerts.length > 0 ? 
                                        securityAlerts.slice(0, 3).map(alert => `<div>‚Ä¢ Alert: ${alert}</div>`).join('') 
                                        : ''
                                    }
                                </div>
                            </div>
                        `;
                    }

                    return `
                        <div class="event-item">
                            <div class="event-indicator ${indicatorClass}">${icon}</div>
                            <div class="event-content">
                                <div class="event-title">${event.type || 'Security Event'}</div>
                                <div class="event-description">${event.description || event.message}</div>
                                ${threatDetails}
                                <div class="event-meta">
                                    <div class="event-time">${new Date(event.timestamp).toLocaleString()}</div>
                                    <div class="event-severity ${event.severity || 'info'}">${(event.severity || 'info').toUpperCase()}</div>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');

                allEventsContainer.innerHTML = eventsHtml;
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            refreshEvents();
            setInterval(refreshEvents, 5000); // Refresh every 5 seconds
        });
    </script>
</body>
</html>